#! /bin/bash
################################################################
# Begin xlapp-boot-watchdog-runner
#
# Description : Intended to be run in the background...Waits a
#               specified period of time, and then resets the
#               GRUB configuration to a previously known good
#               configuration, and the reboots.
#
# Author      : Qrux - qrux dot qed @ gmail.com
#
# Version     : X/LAPP-0.01
#
################################################################

set -e

. /lib/lsb/init-functions

unset totime
totime() { date '+%Y%m%d_%H%M%S'; }

XLAPP_BOOTWATCH_TIMEOUT=$1

if [ -z $XLAPP_BOOTWATCH_TIMEOUT ] ; then
	echo
	echo "  Usage $0 <timeout>"
	echo
	exit
fi

XLAPP_RUN_DIR=/var/run/xlapp
XLAPP_BOOTWATCH_PIDFILE="${XLAPP_RUN_DIR}/boot-watchdog.pid"
XLAPP_GRUB_CONFIG=/boot/grub/menu.lst
XLAPP_SAFE_BOOT_CONFIG="${XLAPP_GRUB_CONFIG}-HOST"
XLAPP_BROKEN_BOOT_CONFIG="${XLAPP_GRUB_CONFIG}-BROKEN-$(totime)"
XLAPP_BOOTWATCH_START_LINK=/etc/rc.d/rc3.d/S*xlapp-boot-watchdog

if [ ! -f $XLAPP_SAFE_BOOT_CONFIG ] ; then
	log_warning_msg "No SAFE boot config found; exiting."
	exit
fi

if [ ! -d $XLAPP_RUN_DIR ] ; then mkdir -pv $XLAPP_RUN_DIR ; fi

CMD="${1}"

case "${CMD}" in
start)
	if [ -f $XLAPP_BOOTWATCH_PIDFILE ] ; then log_warning_msg "Already a boot-watchdog running; aborting" ; exit ; fi
	log_info_msg "Sleeping for $XLAPP_BOOTWATCH_TIMEOUT seconds (hoping for manual intervention)..."
	# Reset GRUB config
	( echo $$ > $XLAPP_BOOTWATCH_PIDFILE && \
	    sleep $XLAPP_BOOTWATCH_TIMEOUT && \
	    /bin/mv -vf $XLAPP_GRUB_CONFIG $XLAPP_BROKEN_BOOT_CONFIG && \
	    /bin/cp -vf $XLAPP_SAFE_BOOT_CONFIG $XLAPP_GRUB_CONFIG ; \
	    /sbin/reboot ) &
	;;

stop)
	if [ -f $XLAPP_BOOTWATCH_PIDFILE ] ; then
		PID=$(cat $XLAPP_BOOTWATCH_PIDFILE)
		log_info_msg "Killing boot-watchdog with PID $PID"
		kill -9 $(cat $XLAPP_BOOTWATCH_PIDFILE)
		evaluate_retval
		echo "If successful here, run '$0 uninstall' to remove boot-watchdog."
	else
		log_warning_msg "No boot-watchdog running.\n"
	fi
	;;

uninstall)
	log_info_msg "Removing boot-bootwatch script: $XLAPP_BOOTWATCH_START_LINK"
	/bin/rm -f $XLAPP_BOOTWATCH_START_LINK
	evaluate_retval
	;;

status)
	if [ -f $XLAPP_BOOTWATCH_PIDFILE ] ; then
		PID=$(cat $XLAPP_BOOTWATCH_PIDFILE)
		echo "Boot-watchdog running with PID $PID"
	else
		echo "No boot-watchdog running."
	fi
	;;

*)
	echo "Usage: $0 {start|stop|status|uninstall}"
	exit 1
	;;
esac

# End xlapp-boot-watchdog bootscript

